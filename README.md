# AntiBullyBot

## Архітектура

AntiBullyBot це телеграм чат-бот, що допомагає протидіяти булінгу. 
У вигляді інтерактивних діалогів бот надає інформацію різним групам аудиторії:
дорослим, дітям (як тим, хто є мішенню булінгу, так і тим, хто в ролі агресора чи спостерігача)

### 1. Основні компоненти: 
- bot.js – головний файл, який ініціалізує та запускає чат-бот.
- controller – логіка відповідей бота на дії користувачів
   - controller/botMiddleware.js – проміжне ПЗ для обробки запитів
   - controller/controller.js – основна логіка контролера
- conversations/* – сценарії розмов для різних груп цільової аудиторії
- db/* – функції роботи з базою даних
- utils/* – допоміжні функції та логування
### 2. Технічне середовище
- Node.js
- БД: MySQL (бібліотека mysql2)
- Бібліотека для взаємодії з Telegram Bot API: GrammY 
- express.js
### 3. Інтерфейси
**Telegram Bot API:**
Робота додатку можлива в 2 режимах:
- Long-pooling: додаток надсилає "довгоживучі" (до 30 секунд) запити на отримання оновлень від Telegram
- Webhook: Додаток запускає вебсервер, який очікує на запити від серверів Telegram.
Вебсервер: express.js

**База Даних** 
- db/config.js - створення пулу зєднань з БД
- db/stateManager.js - збереження/читання стану користувача
- db/create_tables.sql - запити для створення необхідних для роботи таблиць в БД
Всі функції запису в БД запускаються асинхронно, не блокуючи взаємодію з користувачем
Помилки при запитах до БД також не блокують виконання коду
### 4. Збереження даних користувачів та безпека особистих даних
У додатку stateless архітектура - сервер не зберігає інформацію про стан користувача між запитами.
Вся необхідна дла взаємодії з користувачем інформація передається в тілі контексту
і частково закодована в інлайн-запитах.
Так, крім поточного повідомлення в додаток також надсилається інформація, про повідомлення,
яке йому передувало (для того, щоб мати можливість його відредагувати - видаливши не актуальну
вже інлайн-клавіатуру).  

В базі даних зберігаються: 
- стать користувача (таблиця bot_users). Використовується для форування вірних гендерних закінчень 
при зверненні до користувачів. Наприклад *"зробив/зробила"*. Проте наявність цих даних не критична 
для роботи чат-боту.
Він буде логувати помилки звернень до БД, а до користувача по замовчуванню звертатиметься в чоловічій формі. 
- історія розмовних блоків, з якими взаємодіяв користувач (user-states). 
Наразі додаток не використовує зібрану інформацію. Дані необхідні будуть в майбутньому для
аналізу метрик взаємодії з ботом.  

В БД **НЕ ЗБЕРІГАЮТЬСЯ** чутливі і особисті дані користувачів. Як ідентифікатор в таблицях використано 
Telegram ID користувача — це унікальний цифровий ідентифікатор, що призначається кожному користувачеві
Telegram.  

Це безпечно, оскільки Telegram ID не розкриває особисту інформацію, таку як юзернейм, ім'я, номер телефону тощо.
Знаючи лише Telegram ID, сторонній не зможе безпосередньо ідентифікувати особу.

Хоча Telegram ID сам по собі не є чутливою інформацією, в майбутньому рекомендується хешувати ІД користувачів
перед збереженням в БД. 

### 5. Безпека додатку
Чутлива інформація передається через змінні оточення
Режим додатку передається через змінні оточення в команді запуску додатку
Відповідні облікові дані зберігаються в .env.<mode> файлах

```dotenv
# Необхідні параметри:
# web serwer
PORT=
WEBHOOK_DOMAIN=
# bot
BOT_TOKEN=
# db
DB_HOST=
DB_USER=
DB_NAME=
DB_PASSWORD=
```

## Інфраструктура

Додаток працює в середовищі Node.js і використовує базу даних MySQL.
В тестовому середовищі використовувались:
- Node.js v.20.13 (LTS) та v.16 (LTS)  
**ВАЖЛИВО** на момент написання документації найновіша версія 21 запускалась з помилкою підтримки залежностей, що використовуються в додатку
- MySQL v.5.7.34

### Мережеві вимоги
- мережевий доступ до сервера
- для запуску в режимі WebHook **небхідний** діючий SSL сертифікат


## Запуск
### Webhook mode
`NODE_ENV=prod BOT_MODE=webhook node bot.js`

### Long pooling mode
`NODE_ENV=prod node bot.js`

Для постійної доступності додатку (наприклад для автоматичного перезапуску після потенційного збою 
додатка чи перевантаженні сервера) рекомендується використовувати менеджер PM2
### PM2 start command (dev webhook mode)

```
NODE_ENV=dev BOT_MODE=webhook pm2 start bot.js --name "bot_webhook_dev" --log <logFileName>
```
